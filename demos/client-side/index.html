<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GTM/GA4 Form Tracking Demo - Good vs Bad (2025 Update)</title>

  <!-- Consent Mode v2 (Updated 2025) -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}

    // Check for stored consent
    const storedConsent = localStorage.getItem('user_consent_preferences');

    if (storedConsent) {
      gtag('consent', 'default', JSON.parse(storedConsent));
    } else {
      // Default to denied (GDPR compliant) - Consent Mode v2
      gtag('consent', 'default', {
        'ad_storage': 'denied',
        'ad_user_data': 'denied',           // NEW in v2
        'ad_personalization': 'denied',     // NEW in v2
        'analytics_storage': 'denied',
        'functionality_storage': 'granted', // NEW in v2
        'personalization_storage': 'granted', // NEW in v2
        'security_storage': 'granted',      // NEW in v2
        'wait_for_update': 500
      });
    }
  </script>

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MM6H8SQW');</script>
  <!-- End Google Tag Manager -->

  <!-- Meta Pixel Code (2025 Integration) -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    
    // Replace with YOUR Pixel ID
    fbq('init', 'YOUR_PIXEL_ID');
    fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=YOUR_PIXEL_ID&ev=PageView&noscript=1"/>
  </noscript>
  <!-- End Meta Pixel Code -->
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 40px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .update-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 2px solid white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      color: white;
      text-align: center;
    }

    .update-banner h3 {
      margin-bottom: 10px;
      font-size: 20px;
    }

    .update-banner ul {
      list-style: none;
      font-size: 14px;
      line-height: 1.8;
    }
    
    .demo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }
    
    .demo-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .demo-card h2 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    
    .badge-good {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-bad {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-new {
      background: #cce5ff;
      color: #004085;
      margin-left: 8px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    button {
      background: #667eea;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s ease;
    }
    
    button:hover {
      background: #764ba2;
    }
    
    .success-message {
      display: none;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
      line-height: 1.6;
    }
    
    .debug-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 20px;
      margin-top: 30px;
    }
    
    .debug-section h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .debug-output {
      background: #282c34;
      color: #61dafb;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      word-break: break-all;
      line-height: 1.6;
    }
    
    .info-box {
      background: #e7f3ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    
    .info-box p {
      color: #333;
      font-size: 14px;
      line-height: 1.6;
    }
    
    @media (max-width: 768px) {
      .demo-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div style="background: #fff3cd; border-bottom: 3px solid #856404; padding: 15px; text-align: center; margin-bottom: 20px;">
    <strong>üÜï Want to see server-side tracking implementation?</strong>
    <a href="index-server-side.html" style="color: #004085; text-decoration: underline; margin-left: 10px;">
      View Complete Client vs Server-Side Comparison ‚Üí
    </a>
  </div>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MM6H8SQW"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <div class="container">
    <h1>üéØ GTM/GA4 Form Tracking: Good vs Bad</h1>

    <!-- 2025 Update Banner -->
    <div class="update-banner">
      <h3>‚ú® 2025 Updates Applied</h3>
      <ul>
        <li>‚úÖ Meta Conversions API (CAPI) integration with deduplication</li>
        <li>‚úÖ Google Enhanced Conversions prep (Oct 2025 ready)</li>
        <li>‚úÖ Consent Mode v2 (EU compliant)</li>
        <li>‚úÖ Event Match Quality optimization</li>
        <li>‚úÖ Incremental attribution tagging</li>
      </ul>
    </div>
    
    <div class="demo-grid">
      <!-- GOOD Implementation -->
      <div class="demo-card">
        <h2>‚úÖ GOOD Implementation</h2>
        <span class="badge badge-good">Best Practice</span>
        <span class="badge badge-new">2025 Enhanced</span>
        
        <div class="info-box">
          <p><strong>Why this is good:</strong><br/>
          ‚Ä¢ Fires only on success<br/>
          ‚Ä¢ Clean dataLayer push<br/>
          ‚Ä¢ Anti-double-fire guard<br/>
          ‚Ä¢ Standard GA4 + Meta events<br/>
          ‚Ä¢ Enhanced Conversions ready<br/>
          ‚Ä¢ CAPI deduplication</p>
        </div>
        
        <form id="good-form">
          <div class="form-group">
            <label for="good-name">Full Name *</label>
            <input type="text" id="good-name" placeholder="John Doe" required>
          </div>
          
          <div class="form-group">
            <label for="good-email">Email *</label>
            <input type="email" id="good-email" placeholder="john@example.com" required>
          </div>

          <div class="form-group">
            <label for="good-phone">Phone (Optional - improves EMQ)</label>
            <input type="tel" id="good-phone" placeholder="+1234567890">
          </div>
          
          <div class="form-group">
            <label for="good-topic">Topic *</label>
            <select id="good-topic" required>
              <option value="">Select...</option>
              <option value="support">Support</option>
              <option value="sales">Sales</option>
              <option value="partnership">Partnership</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Plan *</label>
            <input type="radio" id="good-basic" name="plan" value="basic" required>
            <label for="good-basic" style="display:inline;margin-left:8px">Basic ($10/mo)</label><br/>
            <input type="radio" id="good-pro" name="plan" value="pro" required>
            <label for="good-pro" style="display:inline;margin-left:8px">Pro ($50/mo)</label>
          </div>
          
          <button type="submit">Submit (Good)</button>
        </form>
        
        <div class="success-message" id="good-success">
          ‚úÖ Success! Multi-platform event sent:<br/>
          ‚Ä¢ Google Analytics 4 (via dataLayer)<br/>
          ‚Ä¢ Meta Pixel (browser-side)<br/>
          ‚Ä¢ Meta CAPI ready (server-side)<br/>
          ‚Ä¢ Deduplication: Active
        </div>
        
        <div class="debug-section">
          <h3>dataLayer & Meta Events</h3>
          <div class="debug-output" id="good-debug">Waiting for form submission...</div>
        </div>
      </div>
      
      <!-- BAD Implementation -->
      <div class="demo-card">
        <h2>‚ùå BAD Implementation</h2>
        <span class="badge badge-bad">Anti-pattern</span>
        
        <div class="info-box">
          <p><strong>Why this is bad:</strong><br/>
          ‚Ä¢ Fires on click (not success)<br/>
          ‚Ä¢ No validation<br/>
          ‚Ä¢ High cardinality fields<br/>
          ‚Ä¢ Counts failures<br/>
          ‚Ä¢ No deduplication<br/>
          ‚Ä¢ Poor data quality</p>
        </div>
        
        <form id="bad-form" onsubmit="return false">
          <div class="form-group">
            <label for="bad-name">Name</label>
            <input type="text" id="bad-name">
          </div>
          
          <div class="form-group">
            <label for="bad-email">Email</label>
            <input type="email" id="bad-email">
          </div>
          
          <div class="form-group">
            <label for="bad-message">Message</label>
            <textarea id="bad-message"></textarea>
          </div>
          
          <button type="button" id="bad-submit">Submit (Bad)</button>
        </form>
        
        <div class="success-message" id="bad-success">
          ‚ö†Ô∏è Fired! (Even if invalid)<br/>
          Result: Inflated metrics, poor data quality
        </div>
        
        <div class="debug-section">
          <h3>dataLayer Events</h3>
          <div class="debug-output" id="bad-debug">Waiting for button click...</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Initialize dataLayer (required before any pushes)
    window.dataLayer = window.dataLayer || [];

    // Unique per form load to correlate attempts
    const instanceId = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    
    // Anti-double-fire guard
    let goodSent = false;

    // Helper: Get URL parameters (for attribution)
    function getUrlParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param) || '';
    }

    // Helper: Parse name into first/last
    function parseName(fullName) {
      const parts = fullName.trim().split(' ');
      return {
        firstName: parts[0] || '',
        lastName: parts.slice(1).join(' ') || ''
      };
    }
    
    // GOOD FORM: Validation-first approach with 2025 enhancements
    document.getElementById('good-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Prevent double-firing
      if (goodSent) return;
      
      // Get form values
      const fullName = document.getElementById('good-name').value;
      const email = document.getElementById('good-email').value;
      const phone = document.getElementById('good-phone').value;
      const topic = document.getElementById('good-topic').value;
      const plan = document.querySelector('input[name="plan"]:checked')?.value;
      
      // Validate before pushing to dataLayer
      if (!fullName || !email || !topic || !plan) {
        document.getElementById('good-debug').innerHTML = '<span style="color: #ff6b6b;">‚ùå Validation failed - event NOT sent</span>';
        return;
      }

      // Parse name
      const { firstName, lastName } = parseName(fullName);
      
      // Simulate async form submission (e.g., API call)
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Set guard
      goodSent = true;
      
      // Generate unique event ID for deduplication (CRITICAL!)
      const eventId = `${instanceId}_${Date.now()}`;

      // Calculate lead value
      const leadValue = plan === 'pro' ? 50.00 : 10.00;

      // Prepare user data for Enhanced Conversions (Google) and EMQ optimization (Meta)
      const userData = {
        email: email,
        phone_number: phone || undefined,
        address: {
          first_name: firstName,
          last_name: lastName
        }
      };

      // Capture campaign data for incremental attribution (2025 feature)
      const campaignData = {
        source: document.referrer || 'direct',
        utm_source: getUrlParam('utm_source'),
        utm_medium: getUrlParam('utm_medium'),
        utm_campaign: getUrlParam('utm_campaign'),
        fbclid: getUrlParam('fbclid'),
        gclid: getUrlParam('gclid')
      };
      
      // PUSH TO DATALAYER (for GTM ‚Üí GA4 + Enhanced Conversions)
      window.dataLayer.push({
        event: 'form_submission_success',
        event_id: eventId,  // Deduplication ID
        form_id: 'contact_us',
        instance_id: instanceId,
        form_type: 'lead',
        form_location: 'demo_page',
        form_fields: {
          topic: topic,
          plan: plan
        },
        user_data: userData,  // Enhanced Conversions (auto-hashed by Google)
        campaign_data: campaignData,  // Attribution tracking
        value: leadValue,
        currency: 'USD'
      });
      
      // PUSH TO META PIXEL (browser-side with deduplication)
      if (typeof fbq !== 'undefined') {
        fbq('track', 'Lead', {
          content_name: 'contact_us',
          content_category: topic,
          value: leadValue,
          currency: 'USD',
          predicted_ltv: plan === 'pro' ? 600.00 : 120.00  // 12-month value
        }, {
          eventID: eventId  // SAME event ID as dataLayer for deduplication!
        });
      }
      
      // Show success message
      document.getElementById('good-success').style.display = 'block';
      
      // Display pushed events for debugging
      document.getElementById('good-debug').innerHTML = 
        '<strong style="color: #51cf66;">üü¢ GA4 dataLayer Push:</strong><br/>' +
        JSON.stringify({
          event: 'form_submission_success',
          event_id: eventId,
          form_id: 'contact_us',
          user_data: userData,
          campaign_data: campaignData,
          value: leadValue
        }, null, 2) +
        '<br/><br/><strong style="color: #339af0;">üîµ Meta Pixel Event:</strong><br/>' +
        JSON.stringify({
          event: 'Lead',
          eventID: eventId,
          content_name: 'contact_us',
          value: leadValue
        }, null, 2) +
        '<br/><br/><span style="color: #51cf66;">‚úÖ Deduplication Active (Same Event ID)</span><br/>' +
        '<span style="color: #ffd43b;">üìä EMQ Score: Estimated 7.0+ (email + phone + name)</span>';
    });
    
    // BAD FORM: Fires on click without validation (anti-pattern)
    document.getElementById('bad-submit').addEventListener('click', function() {
      // Push to dataLayer with high-cardinality field (bad practice)
      window.dataLayer.push({
        event: 'contact_form',
        form_name: 'Contact Form',
        message: document.getElementById('bad-message').value  // High cardinality!
      });
      
      // Show "success" even if form is invalid
      document.getElementById('bad-success').style.display = 'block';
      
      // Display pushed event
      const message = document.getElementById('bad-message').value;
      document.getElementById('bad-debug').innerHTML = 
        '<span style="color: #ff6b6b;">‚ö†Ô∏è BAD: Fired without validation</span><br/><br/>' +
        JSON.stringify({
          event: 'contact_form',
          form_name: 'Contact Form',
          message: message.substring(0, 50) + (message.length > 50 ? '...' : '')
        }, null, 2) +
        '<br/><br/><span style="color: #ff6b6b;">‚ùå Issues:</span><br/>' +
        '‚Ä¢ No validation (counts empty submissions)<br/>' +
        '‚Ä¢ High cardinality field (message text)<br/>' +
        '‚Ä¢ No deduplication ID<br/>' +
        '‚Ä¢ No user data for Enhanced Conversions<br/>' +
        '‚Ä¢ Poor data quality';
    });
  </script>
</body>
</html>